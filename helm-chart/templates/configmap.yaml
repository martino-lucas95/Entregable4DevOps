apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stock-management.fullname" . }}-backend-config
  labels:
    {{- include "stock-management.backend.labels" . | nindent 4 }}
data:
  PORT: {{ .Values.backend.service.port | quote }}
  NODE_ENV: {{ .Values.environment | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stock-management.fullname" . }}-frontend-config
  labels:
    {{- include "stock-management.frontend.labels" . | nindent 4 }}
data:
  VITE_API_URL: {{ .Values.frontend.apiUrl | quote }}
---
{{- if .Values.prometheus.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stock-management.fullname" . }}-prometheus-config
  labels:
    {{- include "stock-management.labels" . | nindent 4 }}
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.prometheus.scrapeInterval }}
      evaluation_interval: {{ .Values.prometheus.scrapeInterval }}

    scrape_configs:
      # Scrape del backend NestJS
      - job_name: 'nestjs-backend'
        scrape_interval: 15s
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          # Filtrar solo pods del backend
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: {{ include "stock-management.name" . }}
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: keep
            regex: backend
          # Extraer el puerto del pod
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: "3000"
          # Nombre de la instancia
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: instance
{{- end }}
---
{{- if .Values.grafana.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stock-management.fullname" . }}-grafana-datasources
  labels:
    {{- include "stock-management.labels" . | nindent 4 }}
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://{{ include "stock-management.fullname" . }}-prometheus:{{ .Values.prometheus.service.port }}
        isDefault: true
        editable: true
      - name: PostgreSQL
        type: postgres
        uid: postgres-datasource
        access: proxy
        url: {{ include "stock-management.fullname" . }}-postgresql:5432
        user: {{ .Values.postgresql.auth.username }}
        database: {{ .Values.postgresql.auth.database }}
        secureJsonData:
          password: {{ .Values.postgresql.auth.password }}
        jsonData:
          sslmode: "disable"
          postgresVersion: 1300
          timescaledb: false
{{- end }}
---
{{- if .Values.grafana.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stock-management.fullname" . }}-grafana-dashboards-provider
  labels:
    {{- include "stock-management.labels" . | nindent 4 }}
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
{{- end }}
---
{{- if .Values.grafana.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stock-management.fullname" . }}-grafana-dashboard
  labels:
    {{- include "stock-management.labels" . | nindent 4 }}
    grafana_dashboard: "1"
data:
  stock-management-monitoring.json: |-
{{ .Files.Get "dashboards/dashboard.json" | indent 4 }}
{{- end }}
